var d=(s,e,t)=>{if(!e.has(s))throw TypeError("Cannot "+t)};var a=(s,e,t)=>(d(s,e,"read from private field"),t?t.call(s):e.get(s)),l=(s,e,t)=>{if(e.has(s))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(s):e.set(s,t)},p=(s,e,t,h)=>(d(s,e,"write to private field"),h?h.call(s,t):e.set(s,t),t);var r=(s,e,t)=>(d(s,e,"access private method"),t);var i,c,o;class b{constructor(){l(this,c);l(this,i,e=>{});this.pc=new RTCPeerConnection;const e="wss://cloud.achex.ca/yyya-nico.co";this.hubName="WebRTC-Remote-Camera";const t=self.crypto.randomUUID();this.ws=new WebSocket(e),this.track=null,this.joinHub=!1,this.promise=new Promise((h,n)=>{this.resolve=h,this.reject=n}),this.ws.addEventListener("message",h=>{const n=JSON.parse(h.data);switch(console.log(n.type),n.type){case"offer":this.pc.setRemoteDescription(n),this.pc.createAnswer().then(u=>{this.pc.setLocalDescription(u),r(this,c,o).call(this,u)});break;case"answer":this.pc.setRemoteDescription(n),a(this,i).call(this,"接続済み");break;case"candidate":this.pc.addIceCandidate(n.ice);break;case"ready":this.restart(this.track);break;case"requestConstraints":r(this,c,o).call(this,{type:"returnConstraints",constraints:{width:{max:window.screen.width*window.devicePixelRatio},height:{max:window.screen.height*window.devicePixelRatio},aspectRatio:window.screen.height/window.screen.width}});break;case"returnConstraints":this.track.applyConstraints(n.constraints);break;default:console.log(n),n.joinHub&&(this.joinHub=n.joinHub==="OK",this.joinHub?this.resolve():this.reject());break}}),r(this,c,o).call(this,{auth:t,passwd:"none"}),r(this,c,o).call(this,{joinHub:this.hubName}),this.pc.addEventListener("iceconnectionstatechange",()=>{switch(this.pc.iceConnectionState){case"checking":a(this,i).call(this,"確認中...");break;case"connected":a(this,i).call(this,"接続済み");break;case"closed":a(this,i).call(this,"切断しました");break;case"failed":a(this,i).call(this,"切断されました");break;case"disconnected":a(this,i).call(this,"一時的に切断しています");break;default:a(this,i).call(this,this.pc.iceConnectionState);break}}),window.addEventListener("beforeunload",()=>{this.pc.close()})}set onEvent(e){p(this,i,e)}async start(e){a(this,i).call(this,"準備中..."),e&&(this.pc.addTrack(e),this.track=e,r(this,c,o).call(this,{type:"requestConstraints"})),a(this,i).call(this,"接続中..."),this.pc.addEventListener("icecandidate",t=>{t.candidate&&r(this,c,o).call(this,{type:"candidate",ice:t.candidate})}),this.pc.createOffer().then(t=>{this.pc.setLocalDescription(t),r(this,c,o).call(this,t)})}restart(e){a(this,i).call(this,"接続しなおしています..."),this.pc.close(),this.pc=new RTCPeerConnection,this.start(e)}ready(e){r(this,c,o).call(this,{type:"ready"})}}i=new WeakMap,c=new WeakSet,o=async function(e){!this.joinHub&&!e.auth&&!e.joinHub&&await this.promise,this.ws.readyState?this.ws.send(JSON.stringify({...this.joinHub&&{toH:this.hubName},...e})):this.ws.addEventListener("open",()=>{this.ws.send(JSON.stringify({...this.joinHub&&{toH:this.hubName},...e}))},{once:!0})};const f=s=>{const e=document.documentElement;s.addEventListener("click",()=>{document.fullscreenElement?document.exitFullscreen():e.requestFullscreen().catch(h=>{alert("ご利用のブラウザは全画面表示に対応していません"+h.name),s.disabled=!0})});const t=()=>{s.textContent=document.fullscreenElement?"fullscreen_exit":"fullscreen"};document.addEventListener("fullscreenchange",t)},m=()=>{const s=document.body;let e=0;const t=()=>{clearTimeout(e),s.classList.remove("hide"),e=setTimeout(function(){s.classList.add("hide")},3e3)};return window.addEventListener("pointerdown",t),window.addEventListener("pointermove",t),t(),t};export{b as R,f,m as u};
