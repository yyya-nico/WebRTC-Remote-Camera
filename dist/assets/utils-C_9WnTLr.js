var y=s=>{throw TypeError(s)};var w=(s,t,e)=>t.has(s)||y("Cannot "+e);var c=(s,t,e)=>(w(s,t,"read from private field"),e?e.call(s):t.get(s)),f=(s,t,e)=>t.has(s)?y("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(s):t.set(s,e),v=(s,t,e,n)=>(w(s,t,"write to private field"),n?n.call(s,e):t.set(s,e),e),h=(s,t,e)=>(w(s,t,"access private method"),e);const m=()=>(Date.now()%1e5).toString().padStart(5,"0"),p=[],D=()=>{console.table(p)};globalThis.printEvents=D;const H=()=>{const s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return Array.from(crypto.getRandomValues(new Uint32Array(16))).map(e=>s[e%s.length]).join("")};var a,o,d,C;class E{constructor({setupPeerConnectionHandler:t=()=>{},setupDataChannelHandler:e=()=>{},sidHandler:n=()=>{},closedHandler:r=()=>{}}={}){f(this,o);f(this,a,t=>{});this.setupPeerConnectionHandler=t,this.setupDataChannelHandler=e,this.sidHandler=n,this.closedHandler=r,this.pc=new RTCPeerConnection,this.setupPeerConnection();const u="wss://cloud.achex.ca/yyya-nico.co";this.hubName="WebRTC-Remote-Camera";const S=self.crypto.randomUUID();this.ws=new WebSocket(u),this.track=null,this.sid=null,this.secret=null,this.pairSid=null,this.pairSecret=null,this.joinHub=!1,this.promise=new Promise((l,i)=>{this.resolve=l,this.reject=i}),this.ws.addEventListener("message",l=>{const i=JSON.parse(l.data);if(i.secret!==this.secret&&i.secret!==this.pairSecret){console.log(i),i.auth&&i.auth==="OK"?(this.sid=i.SID,this.secret=H(),this.sidHandler(this.sid,this.secret)):i.joinHub?(this.joinHub=i.joinHub==="OK",this.joinHub?this.resolve():this.reject()):i.leftHub&&this.pairSid===i.sID&&(this.pc.close(),this.closedHandler(),this.pairSid=null,this.pairSecret=null,c(this,a).call(this,"切断しました"),this.pc=new RTCPeerConnection,this.setupPeerConnection());return}switch(p.push({timestamp:m(),from:i.sID,to:"me",type:i.type,protocol:"WebSocket"}),i.type){case"offer":this.pairSid=i.sID,this.pc.setRemoteDescription(i),this.pc.createAnswer().then(g=>{this.pc.setLocalDescription(g),h(this,o,d).call(this,{...g})});break;case"answer":this.pc.setRemoteDescription(i),c(this,a).call(this,"接続済み");break;case"candidate":this.pc.addIceCandidate(i.ice);break}}),h(this,o,d).call(this,{auth:S,passwd:"none"}),h(this,o,d).call(this,{joinHub:this.hubName})}set onEvent(t){v(this,a,t)}setupPeerConnection(){this.pc.addEventListener("iceconnectionstatechange",()=>{switch(this.pc.iceConnectionState){case"checking":c(this,a).call(this,"確認中...");break;case"connected":c(this,a).call(this,"接続済み");break;case"closed":this.closedHandler(),this.pairSid=null,this.pairSecret=null,c(this,a).call(this,"切断しました"),this.pc=new RTCPeerConnection,this.setupPeerConnection();break;case"failed":c(this,a).call(this,"切断されました");break;case"disconnected":c(this,a).call(this,"一時的に切断しています");break;default:c(this,a).call(this,this.pc.iceConnectionState);break}}),this.pc.addEventListener("datachannel",t=>{this.dc=t.channel,this.setupDataChannel()}),this.setupPeerConnectionHandler(this.pc)}createDataChannel(){this.dc=this.pc.createDataChannel("data"),this.setupDataChannel()}setupDataChannel(){this.dc.addEventListener("message",t=>{const e=JSON.parse(t.data);switch(p.push({timestamp:m(),from:"",to:"me",type:e.type,protocol:"DataChannel"}),e.type){case"requestConstraints":this.returnConstraints();break;case"returnConstraints":const n=e.constraints,{type:r,angle:u}=screen.orientation;if(r.startsWith("portrait")&&u%180===0||r.startsWith("landscape")&&u%180!==0){const{width:l,height:i,aspectRatio:b}=n;n.width=i,n.height=l,n.aspectRatio=1/b}this.track.applyConstraints(n);break}}),this.setupDataChannelHandler(this.dc)}returnConstraints(){h(this,o,C).call(this,{type:"returnConstraints",constraints:{width:{max:window.innerWidth*window.devicePixelRatio},height:{max:window.innerHeight*window.devicePixelRatio},aspectRatio:window.innerWidth/window.innerHeight}})}async start(t,e,n){c(this,a).call(this,"準備中..."),this.pairSid=e,this.pairSecret=n,c(this,a).call(this,"接続中..."),this.createDataChannel(),t&&(this.pc.addTrack(t),this.track=t,h(this,o,C).call(this,{type:"requestConstraints"})),this.pc.addEventListener("icecandidate",r=>{r.candidate&&h(this,o,d).call(this,{type:"candidate",ice:r.candidate})}),this.pc.createOffer().then(r=>{this.pc.setLocalDescription(r),h(this,o,d).call(this,{...r})})}}a=new WeakMap,o=new WeakSet,d=async function(t){!this.joinHub&&!t.auth&&!t.joinHub&&await this.promise,p.push({timestamp:m(),from:"me",to:this.pairSid,type:t.type,protocol:"WebSocket"});const e=()=>{const n=this.pairSid?{toS:this.pairSid}:this.joinHub?{toH:this.hubName}:{},r=this.pairSecret?this.pairSecret:this.secret;this.ws.send(JSON.stringify({...n,secret:r,...t}))};this.ws.readyState?e():this.ws.addEventListener("open",e,{once:!0})},C=async function(t){this.dc.readyState==="connecting"&&await new Promise(e=>{this.dc.addEventListener("open",e,{once:!0})}),p.push({timestamp:m(),from:"me",to:"",type:t.type,protocol:"DataChannel"}),this.dc.send(JSON.stringify({...t}))};const P=s=>{const t=document.documentElement;s.addEventListener("click",()=>{document.fullscreenElement?document.exitFullscreen():t.requestFullscreen().catch(n=>{alert("ご利用のブラウザは全画面表示に対応していません"+n.name),s.disabled=!0})});const e=()=>{s.textContent=document.fullscreenElement?"fullscreen_exit":"fullscreen"};document.addEventListener("fullscreenchange",e)},L=()=>{const s=document.body;let t=0;const e=()=>{clearTimeout(t),s.classList.remove("hide"),t=setTimeout(function(){s.classList.add("hide")},3e3)};return window.addEventListener("pointerdown",e),window.addEventListener("pointermove",e),e(),e};export{E as R,P as f,L as u};
